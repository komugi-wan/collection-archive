<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>COLLECTION ARCHIVE</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#c5a059">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

    <style>
        /* =========================================
           1. Variables & Reset
           ========================================= */
        :root {
            --bg-color: #fefaf9;
            --card-bg: #ffffff;
            --accent-pink: #f8bbd0;
            --dark-pink: #d81b60;
            --gold: #c5a059;
            --gold-light: #eaddc0;
            --text-main: #5a544e;
            --text-sub: #a69f98;
            --border-color: #f0e6e6;
            --trade-bg: #f4f6fb;
            --trade-text: #607d8b;
            --danger: #e53935;
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-size: 14px;
            line-height: 1.6;
            -webkit-user-select: none;
            overflow-x: hidden;
        }

        /* =========================================
           2. Layouts
           ========================================= */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border-color);
            padding: calc(15px + var(--safe-top)) 20px 15px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 0.1em; color: var(--gold); font-weight: 600; }
        .header-btns { display: flex; gap: 15px; }
        .header-icon { font-size: 1.4rem; color: var(--gold); cursor: pointer; }

        .search-container { position: relative; }
        #searchBar {
            width: 100%; padding: 10px 40px 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 20px; outline: none;
            background: var(--bg-color); font-size: 0.9rem;
        }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }

        main { padding: 20px 15px 100px; }

        /* =========================================
           3. Series Card
           ========================================= */
        .series-card {
            background: var(--card-bg); border-radius: 12px;
            padding: 15px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border-left: 4px solid var(--gold);
        }
        .series-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .series-title { font-weight: 600; font-size: 1rem; flex: 1; }
        .series-meta { font-size: 0.8rem; color: var(--text-sub); }
        .series-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .tag { background: var(--bg-color); color: var(--gold); font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; border: 1px solid var(--gold-light); }

        .item-dots { display: flex; flex-wrap: wrap; gap: 4px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #eee; }
        .dot.have { background: var(--gold); }
        .dot.trade { background: var(--trade-text); }

        /* =========================================
           4. Detail View & Editor
           ========================================= */
        .overlay-view {
            position: fixed; inset: 0; z-index: 200;
            background: var(--bg-color); display: none;
            flex-direction: column;
            padding-top: var(--safe-top);
        }
        .overlay-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            background: #fff;
        }
        .scroll-content { flex: 1; overflow-y: auto; padding: 20px; }

        .detail-img-box {
            width: 100%; aspect-ratio: 1/1; background: #eee;
            border-radius: 12px; overflow: hidden; margin-bottom: 20px;
        }
        .detail-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .detail-info { margin-bottom: 30px; }
        .detail-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
        .detail-sub { color: var(--text-sub); font-size: 0.9rem; margin-bottom: 15px; }

        /* Editor Table */
        .editor-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .editor-row { border-bottom: 1px solid var(--border-color); }
        .editor-row td { padding: 12px 5px; }
        .char-name { font-weight: 500; }
        .num-control { display: flex; align-items: center; gap: 10px; }
        .btn-circle {
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--gold);
            background: #fff; color: var(--gold); display: flex; align-items: center; justify-content: center;
        }
        .btn-circle:active { background: var(--gold); color: #fff; }
        .count-val { min-width: 20px; text-align: center; font-weight: 600; }
        .trade-toggle {
            padding: 4px 10px; border-radius: 15px; font-size: 0.75rem;
            border: 1px solid var(--border-color); color: var(--text-sub);
        }
        .trade-toggle.on { background: var(--trade-bg); color: var(--trade-text); border-color: var(--trade-text); }

        /* =========================================
           5. Floating & Tabs
           ========================================= */
        .fab {
            position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--gold); color: #fff;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(197,160,89,0.4); font-size: 1.5rem;
        }
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(60px + var(--safe-bottom));
            background: #fff; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: var(--safe-bottom);
        }
        .tab-item { color: var(--text-sub); text-align: center; flex: 1; }
        .tab-item.active { color: var(--gold); }
        .tab-item i { font-size: 1.2rem; display: block; }
        .tab-label { font-size: 0.65rem; margin-top: 2px; }

        /* =========================================
           6. Forms
           ========================================= */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.85rem; color: var(--text-sub); margin-bottom: 8px; }
        input[type="text"], textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; outline: none;
        }
        .btn-main {
            width: 100%; padding: 15px; background: var(--gold); color: #fff;
            border: none; border-radius: 8px; font-weight: 600; margin-top: 10px;
        }

        /* Missing List */
        .missing-item {
            background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color);
        }
        .missing-info div:first-child { font-weight: 600; }
        .missing-info div:last-child { font-size: 0.8rem; color: var(--text-sub); }
        .jump-btn { color: var(--gold); font-size: 1.2rem; }

        /* Animation */
        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-up { animation: slideIn 0.3s ease-out; }

        /* Modal for Export/Import */
        #settingsModal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 500;
        }
        .modal-content {
            background: #fff; width: 85%; border-radius: 15px; padding: 25px;
        }
        .modal-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: #fff; text-align: left; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <header id="mainHeader">
        <div class="header-top">
            <h1>COLLECTION ARCHIVE</h1>
            <div class="header-btns">
                <i class="fa-solid fa-sliders header-icon" onclick="App.openSettings()"></i>
            </div>
        </div>
        <div class="search-container">
            <input type="text" id="searchBar" placeholder="作品名・タグで検索..." oninput="Render.seriesList()">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
        </div>
    </header>

    <main id="listView">
        </main>

    <div id="missingView" style="display:none; padding: 20px 15px 100px;">
        </div>

    <div id="detailView" class="overlay-view animate-up">
        <div class="overlay-header">
            <i class="fa-solid fa-chevron-left" onclick="App.closeDetail()"></i>
            <span style="font-weight:600">アイテム詳細</span>
            <i class="fa-solid fa-trash-can" style="color:var(--danger)" onclick="App.deleteSeries()"></i>
        </div>
        <div class="scroll-content" id="detailContent"></div>
    </div>

    <div id="editorView" class="overlay-view animate-up">
        <div class="overlay-header">
            <i class="fa-solid fa-xmark" onclick="App.closeEditor()"></i>
            <span style="font-weight:600" id="editorTitle">シリーズ登録</span>
            <span style="color:var(--gold); font-weight:600" onclick="App.saveSeries()">保存</span>
        </div>
        <div class="scroll-content">
            <div class="form-group">
                <label class="form-label">画像 (任意)</label>
                <div class="detail-img-box" onclick="document.getElementById('fileInput').click()" style="cursor:pointer; border: 2px dashed var(--gold-light); display:flex; align-items:center; justify-content:center; color:var(--gold)">
                    <img id="previewImg" style="display:none">
                    <div id="uploadPlaceholder"><i class="fa-solid fa-camera"></i> タップして画像を選択</div>
                </div>
                <input type="file" id="fileInput" hidden accept="image/*" onchange="App.handleFile(this)">
            </div>
            <div class="form-group">
                <label class="form-label">シリーズ名/作品名</label>
                <input type="text" id="editTitle" placeholder="例：〇〇 缶バッジA">
            </div>
            <div class="form-group">
                <label class="form-label">タグ (カンマ区切り)</label>
                <input type="text" id="editTags" placeholder="例：作品A, 2024, 推しB">
            </div>
            <div class="form-group">
                <label class="form-label">キャラクター名 (一行に一名ずつ)</label>
                <textarea id="editChars" rows="8" placeholder="例：&#10;キャラクターA&#10;キャラクターB"></textarea>
            </div>
        </div>
    </div>

    <div id="settingsModal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-content">
            <h3 style="margin-top:0">データ管理</h3>
            <button class="modal-btn" onclick="App.exportData()"><i class="fa-solid fa-download"></i> JSONバックアップを保存</button>
            <button class="modal-btn" onclick="document.getElementById('importInput').click()"><i class="fa-solid fa-upload"></i> バックアップを復元</button>
            <input type="file" id="importInput" hidden accept=".json" onchange="App.importData(this)">
            <p style="font-size:0.7rem; color:var(--text-sub); margin-bottom:0">※データはブラウザ(IndexedDB)に保存されています。機種変更時はバックアップを推奨します。</p>
        </div>
    </div>

    <div class="fab" onclick="App.openEditor()"><i class="fa-solid fa-plus"></i></div>

    <nav class="tab-bar">
        <div class="tab-item active" id="tab-home" onclick="App.switchTab('home')">
            <i class="fa-solid fa-house"></i>
            <div class="tab-label">ホーム</div>
        </div>
        <div class="tab-item" id="tab-missing" onclick="App.switchTab('missing')">
            <i class="fa-solid fa-clipboard-list"></i>
            <div class="tab-label">未所持</div>
        </div>
    </nav>

    <script>
        /* =========================================
           7. IndexedDB Storage with Dexie.js
           ========================================= */
        const db = new Dexie("CollectionArchiveDB");
        db.version(1).stores({
            series: "++id, title, *tags" // id: 自動採番, title: タイトル, tags: 配列展開用
        });

        const Store = {
            data: [],
            currentSeriesId: null,
            editorFromMissing: false,

            async load() {
                // 初回起動時：localStorageからの移行処理
                const legacyData = localStorage.getItem('goods_data');
                const isMigrated = localStorage.getItem('indexeddb_migrated');
                
                if (legacyData && !isMigrated) {
                    try {
                        const parsed = JSON.parse(legacyData);
                        if (parsed.length > 0) {
                            // Dexieに一括追加
                            await db.series.bulkAdd(parsed.map(i => {
                                delete i.id; // 自動採番に任せる
                                return i;
                            }));
                        }
                        localStorage.setItem('indexeddb_migrated', 'true');
                        console.log("Migration to IndexedDB completed.");
                    } catch(e) { console.error("Migration failed", e); }
                }

                // IndexedDBから全取得
                this.data = await db.series.toArray();
            },

            async save() {
                // 基本的に操作ごとにdbに直接書き込むが、メモリ上も同期
                this.data = await db.series.toArray();
            }
        };

        /* =========================================
           8. Render Engine
           ========================================= */
        const Render = {
            async seriesList() {
                const q = document.getElementById('searchBar').value.toLowerCase();
                const container = document.getElementById('listView');
                container.innerHTML = '';

                // IndexedDBから最新を取得してフィルタリング
                const all = await db.series.toArray();
                const filtered = all.filter(s => 
                    s.title.toLowerCase().includes(q) || 
                    s.tags.some(t => t.toLowerCase().includes(q))
                ).reverse();

                filtered.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'series-card';
                    card.onclick = () => App.openDetail(s.id);

                    const haveCount = s.items.filter(i => i.count > 0).length;
                    const total = s.items.length;

                    card.innerHTML = `
                        <div class="series-header">
                            <div class="series-title">${s.title}</div>
                            <div class="series-meta">${haveCount} / ${total}</div>
                        </div>
                        <div class="series-tags">
                            ${s.tags.map(t => `<span class="tag" onclick="event.stopPropagation(); App.filterByTag('${t}')">#${t}</span>`).join('')}
                        </div>
                        <div class="item-dots">
                            ${s.items.map(i => `
                                <div class="dot ${i.count > 0 ? 'have' : ''} ${i.isTrade ? 'trade' : ''}"></div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(card);
                });
            },

            async detail(id) {
                const s = await db.series.get(id);
                if(!s) return;
                const container = document.getElementById('detailContent');
                
                const tagHtml = s.tags.map(t => `<span class="tag">#${t}</span>`).join(' ');

                let html = `
                    <div class="detail-img-box">
                        ${s.image ? `<img src="${s.image}">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#ccc">No Image</div>'}
                    </div>
                    <div class="detail-info">
                        <div class="detail-title">${s.title}</div>
                        <div class="detail-sub">${tagHtml}</div>
                    </div>
                    <button class="btn-main" style="background:var(--bg-color); color:var(--gold); border:1px solid var(--gold); margin-bottom:20px" onclick="App.openEditor(${s.id})">構成を編集</button>
                    <table class="editor-table">
                `;

                s.items.forEach((item, idx) => {
                    html += `
                        <tr class="editor-row">
                            <td class="char-name">${item.name}</td>
                            <td style="width:100px">
                                <div class="num-control">
                                    <div class="btn-circle" onclick="App.updateCount(${s.id}, ${idx}, -1)"><i class="fa-solid fa-minus"></i></div>
                                    <div class="count-val">${item.count}</div>
                                    <div class="btn-circle" onclick="App.updateCount(${s.id}, ${idx}, 1)"><i class="fa-solid fa-plus"></i></div>
                                </div>
                            </td>
                            <td style="width:60px; text-align:right">
                                <div class="trade-toggle ${item.isTrade ? 'on' : ''}" onclick="App.toggleTrade(${s.id}, ${idx})">譲渡可</div>
                            </td>
                        </tr>
                    `;
                });

                html += `</table>`;
                container.innerHTML = html;
            },

            async missingList() {
                const container = document.getElementById('missingView');
                container.innerHTML = '<h2 style="font-size:1.1rem; margin-bottom:20px">未所持アイテム一覧</h2>';
                
                const all = await db.series.toArray();
                let hasMissing = false;

                all.forEach(s => {
                    s.items.forEach((item, idx) => {
                        if(item.count === 0) {
                            hasMissing = true;
                            const div = document.createElement('div');
                            div.className = 'missing-item';
                            div.innerHTML = `
                                <div class="missing-info">
                                    <div>${item.name}</div>
                                    <div>${s.title}</div>
                                </div>
                                <div class="jump-btn" onclick="App.jumpToEditorFromMissing(${s.id}, ${idx}, '${item.name}')">
                                    <i class="fa-solid fa-circle-chevron-right"></i>
                                </div>
                            `;
                            container.appendChild(div);
                        }
                    });
                });
                if(!hasMissing) container.innerHTML += '<p style="color:var(--text-sub)">未所持のアイテムはありません。</p>';
            }
        };

        /* =========================================
           9. App Logic
           ========================================= */
        const App = {
            currentImage: null,

            async init() {
                await Store.load();
                Render.seriesList();
            },

            // Navigation
            switchTab(tab) {
                const home = document.getElementById('listView');
                const missing = document.getElementById('missingView');
                const header = document.getElementById('mainHeader');
                const tHome = document.getElementById('tab-home');
                const tMissing = document.getElementById('tab-missing');

                if(tab === 'home') {
                    home.style.display = 'block';
                    header.style.display = 'block';
                    missing.style.display = 'none';
                    tHome.classList.add('active');
                    tMissing.classList.remove('active');
                    Render.seriesList();
                } else {
                    home.style.display = 'none';
                    header.style.display = 'none';
                    missing.style.display = 'block';
                    tHome.classList.remove('active');
                    tMissing.classList.add('active');
                    Render.missingList();
                }
            },

            // Editor
            async openEditor(id = null) {
                const view = document.getElementById('editorView');
                const title = document.getElementById('editorTitle');
                const preview = document.getElementById('previewImg');
                const placeholder = document.getElementById('uploadPlaceholder');
                
                view.style.display = 'flex';
                history.pushState({view: 'editor'}, '');

                if(id) {
                    const s = await db.series.get(id);
                    Store.currentSeriesId = id;
                    title.innerText = "シリーズ編集";
                    document.getElementById('editTitle').value = s.title;
                    document.getElementById('editTags').value = s.tags.join(', ');
                    document.getElementById('editChars').value = s.items.map(i => i.name).join('\n');
                    if(s.image) {
                        preview.src = s.image;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                        this.currentImage = s.image;
                    }
                } else {
                    Store.currentSeriesId = null;
                    title.innerText = "シリーズ登録";
                    document.getElementById('editTitle').value = '';
                    document.getElementById('editTags').value = '';
                    document.getElementById('editChars').value = '';
                    preview.style.display = 'none';
                    placeholder.style.display = 'flex';
                    this.currentImage = null;
                }
            },

            closeEditor() {
                document.getElementById('editorView').style.display = 'none';
                if(history.state && history.state.view === 'editor') history.back();
            },

            handleFile(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    const preview = document.getElementById('previewImg');
                    preview.src = this.currentImage;
                    preview.style.display = 'block';
                    document.getElementById('uploadPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            },

            async saveSeries() {
                const title = document.getElementById('editTitle').value;
                if(!title) return alert("タイトルを入力してください");

                const tagInput = document.getElementById('editTags').value;
                const tags = tagInput.split(',').map(t => t.trim()).filter(t => t);
                
                const charInput = document.getElementById('editChars').value;
                const charNames = charInput.split('\n').map(n => n.trim()).filter(n => n);

                let existingItems = [];
                if(Store.currentSeriesId) {
                    const old = await db.series.get(Store.currentSeriesId);
                    existingItems = old.items;
                }

                const items = charNames.map(name => {
                    const match = existingItems.find(ei => ei.name === name);
                    return match ? match : { name, count: 0, isTrade: false };
                });

                const seriesData = {
                    title,
                    tags,
                    items,
                    image: this.currentImage,
                    updatedAt: Date.now()
                };

                if(Store.currentSeriesId) {
                    await db.series.update(Store.currentSeriesId, seriesData);
                } else {
                    await db.series.add(seriesData);
                }

                this.closeEditor();
                Render.seriesList();
                if(Store.currentSeriesId) Render.detail(Store.currentSeriesId);
            },

            // Detail & Count
            async openDetail(id) {
                Store.currentSeriesId = id;
                await Render.detail(id);
                document.getElementById('detailView').style.display = 'flex';
                history.pushState({view: 'detail'}, '');
            },

            closeDetail() {
                document.getElementById('detailView').style.display = 'none';
                if(history.state && history.state.view === 'detail') history.back();
                Render.seriesList();
            },

            async updateCount(sId, itemIdx, diff) {
                const s = await db.series.get(sId);
                const newCount = Math.max(0, s.items[itemIdx].count + diff);
                s.items[itemIdx].count = newCount;
                await db.series.update(sId, { items: s.items });
                Render.detail(sId);
            },

            async toggleTrade(sId, itemIdx) {
                const s = await db.series.get(sId);
                s.items[itemIdx].isTrade = !s.items[itemIdx].isTrade;
                await db.series.update(sId, { items: s.items });
                Render.detail(sId);
            },

            async deleteSeries() {
                if(!confirm("このシリーズを削除しますか？")) return;
                await db.series.delete(Store.currentSeriesId);
                this.closeDetail();
            },

            // Utility
            openSettings() {
                document.getElementById('settingsModal').style.display = 'flex';
            },

            async exportData() {
                const all = await db.series.toArray();
                const blob = new Blob([JSON.stringify(all, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `my_collection_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },

            async importData(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if(confirm(`${imported.length}件のデータを上書き復元しますか？（現在のデータは全て削除されます）`)) {
                            await db.series.clear();
                            await db.series.bulkAdd(imported.map(i => {
                                delete i.id;
                                return i;
                            }));
                            location.reload();
                        }
                    } catch(err) { alert("無効なファイル形式です"); }
                };
                reader.readAsText(file);
            },

            filterByTag(t) {
                document.getElementById('searchBar').value = t;
                Render.seriesList();
                window.scrollTo({top:0, behavior:'smooth'});
            },

            async jumpToEditorFromMissing(sId, itemIdx, charName) {
                Store.currentSeriesId = sId;
                await App.openItemEditorFromMissing(sId, itemIdx, charName);
            },

            async openItemEditorFromMissing(sId, itemIdx, charName) {
                // 未所持リストから直接詳細を開く挙動
                await this.openDetail(sId);
                setTimeout(() => {
                    const rows = document.querySelectorAll('.editor-row');
                    for(let row of rows) {
                        if(row.innerText.includes(charName)) {
                            row.scrollIntoView({behavior: 'smooth', block: 'center'});
                            row.style.outline = "2px solid var(--gold)";
                            setTimeout(() => row.style.outline = "none", 2000);
                            break;
                        }
                    }
                }, 300);
            }
        };

        // Browser History Handling
        window.onpopstate = function(e) {
            const editor = document.getElementById('editorView');
            const detail = document.getElementById('detailView');
            editor.style.display = 'none';
            detail.style.display = 'none';
        };

        // Initialize
        App.init();

    </script>
</body>
</html>
